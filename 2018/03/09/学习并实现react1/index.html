<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    
    <title>学习并实现react1 | Minimalist</title>
    
    <link rel="alternative" href="/atom.xml" title="Minimalist" type="application/atom+xml">
    
    <link rel="stylesheet" href="/css/style.css">
    
    <link rel="stylesheet" href="/libs/fancybox/jquery.fancybox.css" charset="utf-8">
    
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>
<body class="site">
    <header class="site-header">
        <h1 class="site-title"><a href="/">Minimalist</a></h1>
        <nav class="site-nav">
            <ul class="nav">
                
                <li><a href="/archives">Archives</a></li>
                
                
                <li><a href="https://github.com/sfyr111" title="git">GITHUB</a></li>
                
                <li><a class="toggle-search" href="#search">search</a></li>
            </ul>
        </nav>
        <div class="site-search" id="search">
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
        </div>
        
            <div class="site-header-background" style="background-image:url(http://reumia.github.io/hexo-theme-zzoman2015/images/background-zzoman2015.jpg)"></div>
        
    </header>
    <div class="site-body">
        <div class="global-width">
    <article class="article" data-layout="post" data-slug="学习并实现react1">
        <div class="article-content">
            
            
            <header class="article-header">
                <div class="article-meta">
                    <a href="/2018/03/09/学习并实现react1/" class="article-date">
  <time datetime="2018-03-09T10:37:23.000Z">2018-03-09</time>
</a>
                    
  <div class="article-category categories">
    <a class="category-link" href="/categories/React/">React</a>
  </div>

                    
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/React/">React</a></li></ul>

                </div>
                
    <h1 class="article-title" itemprop="name">
      <a href="/2018/03/09/学习并实现react1/">学习并实现react1</a>
    </h1>

            </header>
            
            <div class="article-body">
                <h3 id="搭建学习环境"><a href="#搭建学习环境" class="headerlink" title="搭建学习环境"></a>搭建学习环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install -g parcel-bundler</span><br></pre></td></tr></table></figure>
<p>package.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;myReact&quot;,</span><br><span class="line">  &quot;version&quot;: &quot;1.0.0&quot;,</span><br><span class="line">  &quot;description&quot;: &quot;&quot;,</span><br><span class="line">  &quot;main&quot;: &quot;index.js&quot;,</span><br><span class="line">  &quot;scripts&quot;: &#123;</span><br><span class="line">    &quot;start&quot;: &quot;parcel index.html&quot;,</span><br><span class="line">    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;keywords&quot;: [],</span><br><span class="line">  &quot;author&quot;: &quot;&quot;,</span><br><span class="line">  &quot;license&quot;: &quot;ISC&quot;,</span><br><span class="line">  &quot;dependencies&quot;: &#123;</span><br><span class="line">    &quot;babel-preset-env&quot;: &quot;^1.6.1&quot;,</span><br><span class="line">    &quot;babel-preset-es2015&quot;: &quot;^6.24.1&quot;,</span><br><span class="line">    &quot;parcel-bundler&quot;: &quot;^1.6.2&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;devDependencies&quot;: &#123;</span><br><span class="line">    &quot;babel-plugin-transform-react-jsx&quot;: &quot;^6.24.1&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="支持-JSX"><a href="#支持-JSX" class="headerlink" title="支持 JSX"></a>支持 JSX</h3><p>在 js 文件中我们是不能写 jsx 语法的，必须使用一种 babel 插件 transform-react-jsx 才能使用。<br>新建.babelrc<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  &quot;presets&quot;: [&quot;env&quot;],</span><br><span class="line">  &quot;plugins&quot;: [</span><br><span class="line">    [&quot;transform-react-jsx&quot;, &#123;</span><br><span class="line">      &quot;pragma&quot;: &quot;createElement&quot;</span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这样我们在写React 组件时 babel 会帮我们自动编译成<img src="http://upload-images.jianshu.io/upload_images/2155778-b80405e1ab2aa020.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt=""></p>
<h3 id="实现一个-createElement"><a href="#实现一个-createElement" class="headerlink" title="实现一个 createElement"></a>实现一个 createElement</h3><p>.babelrc 文件中使用了<code>transform-react-jsx</code> 插件，告诉babel 解析 jsx 需要 <code>createElement</code>方法，也就是 babel 编译后的<code>React.createElement</code><img src="http://upload-images.jianshu.io/upload_images/2155778-b80405e1ab2aa020.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt=""></p>
<p>createElement 有三个参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">function createElement(type, props, ...args) &#123;</span><br><span class="line">    props = props || &#123;&#125;</span><br><span class="line">    let children = []</span><br><span class="line">    for (let i = 0; i &lt; args.length; i++) &#123;</span><br><span class="line">        if (Array.isArray(args[i])) &#123;</span><br><span class="line">          children = [ ...children, ...args[i] ]</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">          children = [ ...children, args[i] ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  return &#123; type, props, children &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>然后我们来试验下createElement 结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createElement &#125; from &apos;./src/react&apos;</span><br><span class="line"></span><br><span class="line">const React = &#123;&#125;</span><br><span class="line">React.createElement = createElement</span><br><span class="line">React.Component = class Component &#123;&#125;</span><br><span class="line"></span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;span&gt;App&lt;/span&gt;</span><br><span class="line">        &lt;span&gt;component&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const app = new App().render()</span><br><span class="line">console.log(app)</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2155778-8da00c5e8402a857.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt=""></p>
<p><code>new App().render()</code> 这种格式跟 react 组件区别有些大，再实现一个<code>renderVDOM(&lt;App /&gt;)</code> 的格式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">function reactVDOM(vnode) &#123;</span><br><span class="line">    if (typeof vnode === &apos;string&apos;) return vnode // 文本节点</span><br><span class="line">    if (typeof vnode.type === &apos;string&apos;) &#123; // type 为标签名 - dom节点</span><br><span class="line">        let ret = &#123;</span><br><span class="line">            type: ret.type,</span><br><span class="line">            props: ret.props,</span><br><span class="line">            children: []</span><br><span class="line">        &#125;</span><br><span class="line">        for (let i = 0; i &lt; vnode.children.length; i++) &#123;</span><br><span class="line">            ret.children.push(reactVDOM(vnode.children[i])) // 递归children</span><br><span class="line">        &#125;</span><br><span class="line">        return ret </span><br><span class="line">    &#125; </span><br><span class="line">    if (typeof vnode.type === &apos;function&apos;) &#123; // type 为 class 组件</span><br><span class="line">        let func = vnode.type</span><br><span class="line">        let inst = new func(vnode.props) // 把 props 传入</span><br><span class="line">        let innerVNODE = inst.render()</span><br><span class="line">        return reactVDOM(innerVNODE) // 递归渲染后的组件</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import &#123; createElement &#125; from &apos;./src/react&apos;</span><br><span class="line">import &#123; renderVDOM &#125; from &apos;./src/renderVDOM&apos;</span><br><span class="line"></span><br><span class="line">const React = &#123;&#125;</span><br><span class="line">React.createElement = createElement</span><br><span class="line">React.Component = class Component &#123;&#125;</span><br><span class="line"></span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;span&gt;App&lt;/span&gt;</span><br><span class="line">        &lt;span&gt;component&lt;/span&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const app = renderVDOM(&lt;App /&gt;)</span><br><span class="line">console.log(app) // 与 new App().render() 一样</span><br></pre></td></tr></table></figure>
<p>父子组件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">class ChildrenChild extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        children-child</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Children extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        children</span><br><span class="line">        &lt;ChildrenChild /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;span&gt;App&lt;/span&gt;</span><br><span class="line">        &lt;span&gt;component&lt;/span&gt;</span><br><span class="line">        &lt;Children /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const app = renderVDOM(&lt;App /&gt;)</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2155778-2ec534f0b7128657.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt=""><br>结果中组件的文本内容、dom、组件实例都在children 数组里，React.render 时只需要识别这些children 就可以做到真实渲染</p>
<h3 id="实现-render"><a href="#实现-render" class="headerlink" title="实现 render"></a>实现 render</h3><p>改写 renderVDMO 加入真实 dom 操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">function render(vnode, parent) &#123;</span><br><span class="line">  let dom</span><br><span class="line">  if (typeof vnode === &apos;string&apos;) &#123; // 文本节点直接渲染</span><br><span class="line">    dom = document.createTextNode(vnode)</span><br><span class="line">    parent.appendChild(dom)</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  if (typeof vnode.type === &apos;string&apos;) &#123; // dom 节点</span><br><span class="line">    dom = document.createElement(vnode.type)</span><br><span class="line">    setAttrs(dom, vnode.props) // props 已经被createElement 解析成对象</span><br><span class="line">    parent.appendChild(dom)</span><br><span class="line"></span><br><span class="line">    for(let i = 0; i &lt; vnode.children.length; i++) &#123;</span><br><span class="line">      render(vnode.children[i], dom) // 递归 render children</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof vnode.type === &apos;function&apos;) &#123; // class 组件</span><br><span class="line">    let func = vnode.type</span><br><span class="line">    let inst = new func(vnode.props) // props 已经被createElement 解析成对象</span><br><span class="line">    let innerVNode = inst.render()</span><br><span class="line">    render(innerVNode, parent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function setAttrs(dom, props) &#123;</span><br><span class="line">  Object.keys(props).forEach(k =&gt; &#123;</span><br><span class="line">    const v = props[k]</span><br><span class="line">    </span><br><span class="line">    if (k === &apos;className&apos;) &#123;</span><br><span class="line">      dom.setAttribute(&apos;class&apos;, v)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (k === &apos;style&apos;) &#123;</span><br><span class="line">      if (typeof v === &apos;string&apos;) dom.style.cssText = v</span><br><span class="line">      if (typeof v === &apos;object&apos;) &#123;</span><br><span class="line">        for (let i in v) &#123;</span><br><span class="line">          dom.style[i] = v[i]</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    if (k[0] === &apos;o&apos; &amp;&amp; k[1] === &apos;n&apos;) &#123; // onClick of onClickCapture</span><br><span class="line">      const capture = k.indexOf(&apos;Capture&apos;) !== -1</span><br><span class="line">      dom.addEventListener(k.replace(&apos;Capture&apos;, &apos;&apos;).substring(2).toLowerCase(), v, capture)</span><br><span class="line">      return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    dom.setAttribute(k, v)</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>把上面例子换一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">// app.js</span><br><span class="line">class ChildrenChild extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        children-child</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Children extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        children</span><br><span class="line">        &lt;ChildrenChild /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;span&gt;App&lt;/span&gt;</span><br><span class="line">        &lt;span&gt;component&lt;/span&gt;</span><br><span class="line">        &lt;Children /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render(&lt;App /&gt;, document.getElementById(&apos;app&apos;))</span><br><span class="line"></span><br><span class="line">// index.html</span><br><span class="line">&lt;body&gt;</span><br><span class="line">  &lt;div id=&quot;app&quot;&gt;&lt;/div&gt;</span><br><span class="line">  &lt;script src=&quot;./app.js&quot;&gt;&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="http://upload-images.jianshu.io/upload_images/2155778-b60fd251a6287b11.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/620" alt="结果"></p>
<h3 id="实现props-和state"><a href="#实现props-和state" class="headerlink" title="实现props 和state"></a>实现props 和state</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">class Color extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div style=&#123;&#123; color: this.props.color &#125;&#125;&gt;color is: &#123;this.props.color&#125;&lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const colorArr = [&apos;red&apos;, &apos;blue&apos;, &apos;black&apos;, &apos;green&apos;, &apos;gray&apos;]</span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props)</span><br><span class="line">    this.state = &#123;</span><br><span class="line">      color: &apos;black&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    console.log(&quot;handleClick&quot;)</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      color: colorArr[Math.random() * 5 | 0]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div onClick=&#123;this.handleClick.bind(this)&#125;&gt;</span><br><span class="line">        &lt;Color color=&#123;this.state.color&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">render(&lt;App /&gt;, document.getElementById(&apos;app&apos;))</span><br></pre></td></tr></table></figure>
<p>目的: 我们要通过点击 App 组件中的元素来改变 Color 文字的颜色<br>步骤: 把新的state 传入 this.setState  来更新组件 - 调用render 方法</p>
<h4 id="setState"><a href="#setState" class="headerlink" title="setState"></a>setState</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">export default class Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    this.props = props</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state) &#123;</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      this.state = state</span><br><span class="line">      // ...render()</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>回忆 render 函数有两个参数，<code>vnode</code>， <code>parent</code>，<code>vnode</code> 我们可以使用 <code>this.render()</code> 获取当前组件，但我们要知道需要更新dom 内容的 <code>parent</code> 就需要在首次render 时记录。</p>
<h4 id="改写-render"><a href="#改写-render" class="headerlink" title="改写 render"></a>改写 render</h4><p>给render 增加参数，<code>comp</code>(当前更新组件)， <code>olddom</code>(当前组件曾经的dom)<br>拿首次渲染举例:  <code>parent - document.getElementById(&#39;app&#39;)</code>, <code>comp - &lt;App /&gt;</code>, <code>olddom -   当App组件更新时就是App 首次渲染的dom</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">export function render(vnode, parent, comp, olddom) &#123;</span><br><span class="line">  let dom</span><br><span class="line">  if (typeof vnode === &apos;string&apos;) &#123; // 文本节点直接渲染</span><br><span class="line">    dom = document.createTextNode(vnode)</span><br><span class="line">    comp &amp;&amp; (comp.__rendered = dom)</span><br><span class="line"></span><br><span class="line">    if (olddom) parent.replaceChild(dom, olddom)</span><br><span class="line">    else parent.appendChild(dom)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof vnode.type === &apos;string&apos;) &#123; // dom 节点</span><br><span class="line">    dom = document.createElement(vnode.type)</span><br><span class="line"></span><br><span class="line">    comp &amp;&amp; (comp.__rendered = dom)</span><br><span class="line">    setAttrs(dom, vnode.props) // props 已经被createElement 解析成对象</span><br><span class="line"></span><br><span class="line">    if (olddom) parent.replaceChild(dom, olddom)</span><br><span class="line">    else parent.appendChild(dom)</span><br><span class="line"></span><br><span class="line">    for(let i = 0; i &lt; vnode.children.length; i++) &#123;</span><br><span class="line">      render(vnode.children[i], dom, null, null) // 递归 render children</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  if (typeof vnode.type === &apos;function&apos;) &#123; // class 组件</span><br><span class="line">    let func = vnode.type</span><br><span class="line">    let inst = new func(vnode.props) // props 已经被createElement 解析成对象</span><br><span class="line"></span><br><span class="line">    comp &amp;&amp; (comp.__rendered = inst) // 这里记录的是 Component 实例</span><br><span class="line"></span><br><span class="line">    let innerVNode = inst.render()</span><br><span class="line">    render(innerVNode, parent, inst, olddom)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>在这里我们每次render 的时候都会判断这次render 是否是class 组件触发的render，如果是组件触发的render 我们就会在这个组件<code>comp</code> 上增加 <code>__rendered</code> 记录当前渲染的 dom 或 当前渲染的组件 (组件追溯到顶层也是dom) ，这时候我们需要一个方法来获得olddom<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">function getDOM (comp) &#123;</span><br><span class="line">  let rendered = comp.__rendered</span><br><span class="line">  while (rendered instanceof Component) &#123;</span><br><span class="line">    rendered = rendered.__rendered</span><br><span class="line">  &#125;</span><br><span class="line">  return rendered</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h5 id="实现-setState"><a href="#实现-setState" class="headerlink" title="实现 setState"></a>实现 setState</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import &#123; getDOM &#125; from &apos;./util&apos;</span><br><span class="line">import &#123; render &#125; from &apos;./render&apos;</span><br><span class="line"></span><br><span class="line">export default class Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    this.props = props</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state) &#123;</span><br><span class="line">    setTimeout(() =&gt; &#123;</span><br><span class="line">      this.state = state</span><br><span class="line">      const vnode = this.render()</span><br><span class="line">      let olddom = getDOM(this) // 获取渲染此实例的 olddom</span><br><span class="line">      render(vnode, olddom.parentNode, this, olddom)</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="实现效果"><a href="#实现效果" class="headerlink" title="实现效果"></a>实现效果</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">import &#123; render, createElement, Component &#125; from &apos;./src/code1/react&apos;</span><br><span class="line"></span><br><span class="line">const React = &#123;&#125;</span><br><span class="line">React.createElement = createElement</span><br><span class="line">React.Component = Component</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class Color extends React.Component &#123;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div style=&#123;&#123; color: this.props.color &#125;&#125;&gt;color is: &#123;this.props.color&#125;&lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const colorArr = [&apos;red&apos;, &apos;blue&apos;, &apos;black&apos;, &apos;green&apos;, &apos;gray&apos;]</span><br><span class="line">class App extends React.Component &#123;</span><br><span class="line">  constructor(props) &#123;</span><br><span class="line">    super(props)</span><br><span class="line">    this.state = &#123;</span><br><span class="line">      color: &apos;black&apos;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  handleClick() &#123;</span><br><span class="line">    console.log(&quot;handleClick&quot;)</span><br><span class="line">    this.setState(&#123;</span><br><span class="line">      color: colorArr[Math.random() * 5 | 0]</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;</span><br><span class="line">    return (</span><br><span class="line">      &lt;div onClick=&#123;this.handleClick.bind(this)&#125;&gt;</span><br><span class="line">        &lt;Color color=&#123;this.state.color&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render(&lt;App /&gt;, document.getElementById(&apos;app&apos;))</span><br></pre></td></tr></table></figure>
            </div>
        </div>
    </article>

    
    
<nav class="article-nav">
  
    <a href="/2018/03/13/学习并实现react2/" id="article-nav-newer" class="article-nav-link-wrap prev">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          学习并实现react2
        
      </div>
    </a>
  
  
    <a href="/2018/02/05/前端基础重点回顾6-渲染机制、页面性能优化、错误监控/" id="article-nav-older" class="article-nav-link-wrap next">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">前端基础重点回顾6:渲染机制、页面性能优化、错误监控</div>
    </a>
  
</nav>

    

    
</div>
    </div>
    <footer class="site-footer">
        <div class="global-width">
            <ul class="site-widget">
                
                <li class="widget widget-tag">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/">JavaScript</a><span class="tag-list-count">6</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React/">React</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/React-Tips/">React Tips</a><span class="tag-list-count">2</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Redux/">Redux</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/">Vue</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/css/">css</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dom/">dom</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/http/">http</a><span class="tag-list-count">5</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/sftp/">sftp</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-category">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Font-End-Basis/">Font-End Basis</a><span class="category-list-count">11</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/http/">http</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/network/">network</a><span class="category-list-count">1</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-recent_posts">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-body">
      <ul>
        
          <li>
            <a href="/2018/10/28/编写React组件要点-单一责任原则/">编写React组件要点-单一责任原则</a>
          </li>
        
          <li>
            <a href="/2018/10/26/HTTP相关系统知识/">HTTP相关系统知识</a>
          </li>
        
          <li>
            <a href="/2018/04/17/JavaScript中的垃圾回收/">JavaScript 中的垃圾回收</a>
          </li>
        
          <li>
            <a href="/2018/04/11/实现一个 Vue (1) 实现响应式原理/">实现一个 Vue (1) 实现响应式原理</a>
          </li>
        
          <li>
            <a href="/2018/04/03/学习并实现 redux(1) - 基础 API/">学习并实现 redux(1) - 基础 API</a>
          </li>
        
      </ul>
    </div>
  </div>

                </li>
                
            </ul>
        </div>
        <div class="site-info">
            <address>
                &copy; 2014 <a href="http://yoursite.com">Minimalist</a> All Right Reserved. <br/>
                Powered by <a href="http://hexo.io">Hexo</a>. Theme by <a href="http://zzoman.com">ZZOMAN</a>
            </address>
        </div>
    </footer>
    
    <script src="/libs/jquery-1.11.3.min.js" type="text/javascript"></script>
    
    <script src="/libs/fancybox/jquery.fancybox.js" type="text/javascript"></script>
    
    <script src="/js/site_init.js" type="text/javascript"></script>
    
</body>
</html>